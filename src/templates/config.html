{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/config.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/providers.css') }}">

<div class="config-container">
    <div class="config-header">
        <h2>Konfiguration</h2>
        <p class="config-subtitle">Einstellungen f√ºr Ultimate UI und Backend-Verbindungen</p>
    </div>

    <div class="config-content">
        <!-- Configuration Tabs -->
        <div class="config-tabs" role="tablist">
            <button class="config-tab active" data-tab="backend" id="tab-backend" role="tab" aria-selected="true" aria-controls="section-backend">
                Backend-Einstellungen
            </button>
            <button class="config-tab" data-tab="providers" id="tab-providers" role="tab" aria-selected="false" aria-controls="section-providers">
                EPG Provider
            </button>
            <button class="config-tab" data-tab="ui" id="tab-ui" role="tab" aria-selected="false" aria-controls="section-ui">
                UI-Einstellungen
            </button>
            <button class="config-tab" data-tab="player" id="tab-player" role="tab" aria-selected="false" aria-controls="section-player">
                Player-Einstellungen
            </button>
            <button class="config-tab" data-tab="advanced" id="tab-advanced" role="tab" aria-selected="false" aria-controls="section-advanced">
                Erweitert
            </button>
        </div>

        <!-- Backend Configuration -->
        <div class="config-section active" id="section-backend" role="tabpanel" aria-labelledby="tab-backend">
            <h3>Backend-Verbindungen</h3>

            <form id="backend-form" class="config-form">
                <div class="form-group">
                    <h4>WebEPG Backend</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="webepg_url">URL</label>
                            <input type="url" id="webepg_url" name="webepg_url"
                                   value="{{ config.webepg.url }}"
                                   placeholder="http://localhost:8080"
                                   class="form-input" required>
                            <small class="form-help">
                                Basis-URL des WebEPG Backends (ohne /api/v1)
                            </small>
                        </div>
                        <div class="form-col">
                            <label for="webepg_timeout">Timeout (Sekunden)</label>
                            <input type="number" id="webepg_timeout" name="webepg_timeout"
                                   value="{{ config.webepg.timeout }}"
                                   min="1" max="60" class="form-input">
                            <small class="form-help">
                                Timeout f√ºr API-Anfragen
                            </small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="test-webepg-btn" class="btn-test">
                            Verbindung testen
                        </button>
                        <div class="connection-status" id="webepg-connection-status">
                            <span class="status-dot" aria-hidden="true"></span>
                            <span class="status-text">Nicht getestet</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>Ultimate Backend</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="ultimate_backend_url">URL</label>
                            <input type="url" id="ultimate_backend_url" name="ultimate_backend_url"
                                   value="{{ config.ultimate_backend.url }}"
                                   placeholder="http://localhost:3000"
                                   class="form-input">
                            <small class="form-help">
                                URL des Ultimate Backends f√ºr EPG-Mapping
                            </small>
                        </div>
                        <div class="form-col">
                            <label for="ultimate_backend_timeout">Timeout (Sekunden)</label>
                            <input type="number" id="ultimate_backend_timeout" name="ultimate_backend_timeout"
                                   value="{{ config.ultimate_backend.timeout }}"
                                   min="1" max="60" class="form-input">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="test-ultimate-btn" class="btn-test">
                            Verbindung testen
                        </button>
                        <div class="connection-status" id="ultimate-backend-status">
                            <span class="status-dot" aria-hidden="true"></span>
                            <span class="status-text">Nicht getestet</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- EPG Providers Configuration -->
        <div class="config-section" id="section-providers" role="tabpanel" aria-labelledby="tab-providers">
            <h3>EPG Provider Management</h3>
            <p class="section-description">Verwalten Sie Ihre EPG-Datenquellen und √ºberwachen Sie den Import-Status</p>

            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">üì°</div>
                    <div class="stat-content">
                        <h3 id="total-providers">0</h3>
                        <p>Total Providers</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3 id="enabled-providers">0</h3>
                        <p>Enabled</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <h3 id="disabled-providers">0</h3>
                        <p>Disabled</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3 id="success-rate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="providers-actions">
                <button class="btn-add-provider" id="add-provider-btn">
                    <span class="btn-icon">+</span>
                    Provider hinzuf√ºgen
                </button>
                <button class="btn-secondary" id="test-all-btn">
                    <span class="btn-icon">üîç</span>
                    Alle testen
                </button>
                <button class="btn-secondary" id="import-all-btn">
                    <span class="btn-icon">üîÑ</span>
                    Alle importieren
                </button>
                <button class="btn-secondary" id="refresh-providers-btn">
                    <span class="btn-icon">‚ü≥</span>
                    Aktualisieren
                </button>
            </div>

            <!-- Providers Table -->
            <div class="providers-table-container">
                <div class="table-header">
                    <h3>EPG Providers</h3>
                    <div class="table-controls">
                        <input type="text" id="provider-search" placeholder="Provider suchen..." class="search-input">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="table">
                                <span class="btn-icon">üìã</span>
                            </button>
                            <button class="view-btn" data-view="cards">
                                <span class="btn-icon">üÉè</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div class="providers-table-view active" id="table-view">
                    <table class="providers-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Name</th>
                                <th>XMLTV URL</th>
                                <th>Letzter Import</th>
                                <th>Import Stats</th>
                                <th class="text-center">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="providers-table-body">
                            <tr class="loading-row">
                                <td colspan="6">
                                    <div class="loading-spinner-small"></div>
                                    <span>Lade Provider...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Cards View -->
                <div class="providers-cards-view" id="cards-view">
                    <div class="cards-grid" id="providers-cards-grid">
                        <div class="loading-card">
                            <div class="loading-spinner-small"></div>
                            <span>Lade Provider...</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state hidden" id="empty-state">
                    <div class="empty-icon">üì°</div>
                    <h3>Keine EPG Provider</h3>
                    <p>Sie haben noch keine EPG-Provider hinzugef√ºgt.</p>
                    <button class="btn-add-provider" id="add-first-provider-btn">
                        <span class="btn-icon">+</span>
                        Ersten Provider hinzuf√ºgen
                    </button>
                </div>
            </div>
        </div>

        <!-- UI Configuration -->
        <div class="config-section" id="section-ui" role="tabpanel" aria-labelledby="tab-ui">
            <h3>UI-Einstellungen</h3>

            <form id="ui-form" class="config-form">
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="ui_theme">Theme</label>
                            <select id="ui_theme" name="ui_theme" class="form-select">
                                <option value="light" {% if config.ui.theme == 'light' %}selected{% endif %}>
                                    Hell
                                </option>
                                <option value="dark" {% if config.ui.theme == 'dark' %}selected{% endif %}>
                                    Dunkel
                                </option>
                                <option value="auto">System</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="timezone">Zeitzone</label>
                            <select id="timezone" name="timezone" class="form-select">
                                <option value="Europe/Berlin" {% if config.ui.timezone == 'Europe/Berlin' %}selected{% endif %}>
                                    Europa/Berlin (MEZ)
                                </option>
                                <option value="UTC" {% if config.ui.timezone == 'UTC' %}selected{% endif %}>
                                    UTC
                                </option>
                                <option value="America/New_York">
                                    America/New_York (EST)
                                </option>
                                <option value="Asia/Tokyo">
                                    Asia/Tokyo (JST)
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="refresh_interval">Auto-Refresh (Sekunden)</label>
                            <input type="number" id="refresh_interval" name="refresh_interval"
                                   value="{{ config.ui.refresh_interval }}"
                                   min="30" max="3600" class="form-input">
                            <small class="form-help">
                                Intervall f√ºr automatische Aktualisierung (0 = deaktiviert)
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>EPG-Anzeige</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="checkbox-label">
                                <input type="checkbox" id="show_icons" name="show_icons"
                                       {% if config.ui.show_icons|default(true) %}checked{% endif %}>
                                <span class="checkmark"></span>
                                Kanal-Icons anzeigen
                            </label>
                        </div>
                        <div class="form-col">
                            <label class="checkbox-label">
                                <input type="checkbox" id="show_descriptions" name="show_descriptions"
                                       {% if config.ui.show_descriptions|default(true) %}checked{% endif %}>
                                <span class="checkmark"></span>
                                Beschreibungen anzeigen
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Player Configuration -->
        <div class="config-section" id="section-player" role="tabpanel" aria-labelledby="tab-player">
            <h3>Player-Einstellungen</h3>

            <form id="player-form" class="config-form">
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="player_size">Standard-Gr√∂√üe</label>
                            <select id="player_size" name="player_size" class="form-select">
                                <option value="small" {% if config.player.default_size == 'small' %}selected{% endif %}>
                                    Klein (480√ó270)
                                </option>
                                <option value="medium" {% if config.player.default_size == 'medium' %}selected{% endif %}>
                                    Mittel (720√ó405)
                                </option>
                                <option value="large" {% if config.player.default_size == 'large' %}selected{% endif %}>
                                    Gro√ü (1080√ó608)
                                </option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="player_bitrate">Standard-Bitrate</label>
                            <select id="player_bitrate" name="player_bitrate" class="form-select">
                                <option value="auto" {% if config.player.default_bitrate == 'auto' %}selected{% endif %}>
                                    Automatisch
                                </option>
                                <option value="1000000" {% if config.player.default_bitrate == '1000000' %}selected{% endif %}>
                                    Bis 1 Mbit
                                </option>
                                <option value="3000000" {% if config.player.default_bitrate == '3000000' %}selected{% endif %}>
                                    Bis 3 Mbit
                                </option>
                                <option value="6000000" {% if config.player.default_bitrate == '6000000' %}selected{% endif %}>
                                    Bis 6 Mbit
                                </option>
                                <option value="10000000" {% if config.player.default_bitrate == '10000000' %}selected{% endif %}>
                                    Bis 10 Mbit
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>Player-Verhalten</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoplay" name="autoplay"
                                       {% if config.player.autoplay|default(true) %}checked{% endif %}>
                                <span class="checkmark"></span>
                                Autoplay aktivieren
                            </label>
                            <small class="form-help">
                                Stream automatisch starten
                            </small>
                        </div>
                        <div class="form-col">
                            <label class="checkbox-label">
                                <input type="checkbox" id="muted" name="muted"
                                       {% if config.player.muted|default(false) %}checked{% endif %}>
                                <span class="checkmark"></span>
                                Standardm√§√üig stumm
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="default_volume">Standard-Lautst√§rke (%)</label>
                            <input type="range" id="default_volume" name="default_volume"
                                   value="{{ config.player.default_volume|default(50) }}"
                                   min="0" max="100" class="form-range" aria-valuemin="0" aria-valuemax="100">
                            <div class="range-value">
                                <span id="volume-value">{{ config.player.default_volume|default(50) }}</span>%
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Configuration -->
        <div class="config-section" id="section-advanced" role="tabpanel" aria-labelledby="tab-advanced">
            <h3>Erweiterte Einstellungen</h3>

            <form id="advanced-form" class="config-form">
                <div class="form-group">
                    <h4>Datenbank</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="retention_days">Aufbewahrungsdauer (Tage)</label>
                            <input type="number" id="retention_days" name="retention_days"
                                   value="{{ config.database.retention_days }}"
                                   min="1" max="365" class="form-input">
                            <small class="form-help">
                                Wie viele Tage EPG-Daten aufbewahrt werden
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>Cache-Einstellungen</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="checkbox-label">
                                <input type="checkbox" id="cache_enabled" name="cache_enabled"
                                       {% if config.get('cache', {}).get('enabled', false) %}checked{% endif %}>
                                <span class="checkmark"></span>
                                Cache aktivieren
                            </label>
                        </div>
                        <div class="form-col">
                            <label for="cache_ttl">Cache-TTL (Sekunden)</label>
                            <input type="number" id="cache_ttl" name="cache_ttl"
                                   value="{{ config.get('cache', {}).get('ttl', 300) }}"
                                   min="60" max="86400" class="form-input">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>Protokollierung</h4>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="log_level">Log-Level</label>
                            <select id="log_level" name="log_level" class="form-select">
                                <option value="DEBUG" {% if config.get('logging', {}).get('level', 'INFO') == 'DEBUG' %}selected{% endif %}>
                                    DEBUG
                                </option>
                                <option value="INFO" {% if config.get('logging', {}).get('level', 'INFO') == 'INFO' %}selected{% endif %}>
                                    INFO
                                </option>
                                <option value="WARNING" {% if config.get('logging', {}).get('level', 'INFO') == 'WARNING' %}selected{% endif %}>
                                    WARNING
                                </option>
                                <option value="ERROR" {% if config.get('logging', {}).get('level', 'INFO') == 'ERROR' %}selected{% endif %}>
                                    ERROR
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Action Buttons -->
        <div class="config-actions">
            <button class="btn-save" id="save-all-config-btn">
                Alle Einstellungen speichern
            </button>
            <button class="btn-reset" id="reset-config-btn">
                Auf Standard zur√ºcksetzen
            </button>
            <button class="btn-export" id="export-config-btn">
                Konfiguration exportieren
            </button>
            <button class="btn-import" id="import-config-btn">
                Konfiguration importieren
            </button>
            <input type="file" id="import-file" accept=".yaml,.yml,.json" style="display: none;">
        </div>

        <!-- Config File Location -->
        <div class="config-info">
            <h4>Konfigurationsdatei</h4>
            <p>
                <strong>Speicherort:</strong> <code>{{ config_path }}</code>
            </p>
            <p>
                <small>
                    Die Konfiguration kann auch √ºber Umgebungsvariablen angepasst werden.
                    Siehe Dokumentation f√ºr Details.
                </small>
            </p>
        </div>
    </div>
</div>

<!-- Pass configuration data to JavaScript -->
<script>
    // Make configuration data available to JavaScript
    window.CONFIG_DATA = {
        webepg: {{ config.webepg|tojson }},
        ultimate_backend: {{ config.ultimate_backend|tojson }},
        ui: {{ config.ui|tojson }},
        player: {{ config.player|tojson }},
        database: {{ config.database|tojson }},
        cache: {{ config.get('cache', {})|tojson }},
        logging: {{ config.get('logging', {})|tojson }},
        config_path: "{{ config_path }}"
    };
</script>

<!-- Load providers.js for the EPG Providers tab -->
<script src="{{ url_for('static', filename='js/providers.js') }}" defer></script>
{% endblock %}