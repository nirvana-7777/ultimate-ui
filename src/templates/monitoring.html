{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitoring.css') }}">

<div class="monitoring-container">
    <div class="monitoring-header">
        <h2>Monitoring & Statistiken</h2>
        <p class="monitoring-subtitle">√úberwachung der EPG-Dienste und Systemstatistiken</p>
    </div>

    <div class="monitoring-content">
        {% if error %}
        <div class="error-message" role="alert">
            <p>‚ö†Ô∏è Fehler beim Laden der Monitoring-Daten: {{ error }}</p>
            <button onclick="location.reload()">Erneut versuchen</button>
        </div>
        {% else %}
        <!-- Health Status Cards -->
        <div class="health-cards">
            <div class="health-card">
                <div class="health-card-header">
                    <h3>WebEPG Backend</h3>
                    <span class="health-status {% if webepg_health %}online{% else %}offline{% endif %}" id="webepg-health-status">
                        {% if webepg_health %}Online{% else %}Offline{% endif %}
                    </span>
                </div>
                <div class="health-card-body">
                    <div class="health-info">
                        <span class="health-label">URL:</span>
                        <span class="health-value">{{ config.webepg.url }}</span>
                    </div>
                    <div class="health-info">
                        <span class="health-label">Letzte Antwort:</span>
                        <span class="health-value" id="webepg-response-time">-</span>
                    </div>
                    <div class="health-actions">
                        <button class="btn-health-check" id="test-webepg-btn">Status pr√ºfen</button>
                        <button class="btn-trigger-import" id="trigger-import-btn">Import starten</button>
                    </div>
                </div>
            </div>

            <div class="health-card">
                <div class="health-card-header">
                    <h3>Ultimate Backend</h3>
                    <span class="health-status" id="ultimate-backend-health-status">Nicht gepr√ºft</span>
                </div>
                <div class="health-card-body">
                    <div class="health-info">
                        <span class="health-label">URL:</span>
                        <span class="health-value">{{ config.ultimate_backend.url }}</span>
                    </div>
                    <div class="health-info">
                        <span class="health-label">Letzte Antwort:</span>
                        <span class="health-value" id="ultimate-backend-response-time">-</span>
                    </div>
                    <div class="health-actions">
                        <button class="btn-health-check" id="test-ultimate-btn">Status pr√ºfen</button>
                    </div>
                </div>
            </div>

            <div class="health-card">
                <div class="health-card-header">
                    <h3>Ultimate UI</h3>
                    <span class="health-status online">Online</span>
                </div>
                <div class="health-card-body">
                    <div class="health-info">
                        <span class="health-label">Version:</span>
                        <span class="health-value">1.0.0</span>
                    </div>
                    <div class="health-info">
                        <span class="health-label">Uptime:</span>
                        <span class="health-value" id="ui-uptime">-</span>
                    </div>
                    <div class="health-info">
                        <span class="health-label">Letzte Aktualisierung:</span>
                        <span class="health-value" id="last-refresh">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="statistics-grid">
            <div class="stat-card wide">
                <div class="stat-card-header">
                    <h3>Datenbank-Statistiken</h3>
                    <button class="btn-refresh-stats" id="refresh-stats-btn">üîÑ Aktualisieren</button>
                </div>
                <div class="stat-card-body">
                    <div class="stat-row">
                        <div class="stat-item">
                            <span class="stat-label">Kan√§le gesamt</span>
                            <span class="stat-value" id="total-channels">{{ statistics.total_channels|default('0') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Programme gesamt</span>
                            <span class="stat-value" id="total-programs">{{ statistics.total_programs|default('0') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Provider</span>
                            <span class="stat-value" id="total-providers">{{ statistics.total_providers|default('0') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Aliase</span>
                            <span class="stat-value" id="total-aliases">{{ statistics.total_aliases|default('0') }}</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-item">
                            <span class="stat-label">Fr√ºhestes Programm</span>
                            <span class="stat-value" id="earliest-program">{{ statistics.earliest_program|default('-') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Neuestes Programm</span>
                            <span class="stat-value" id="latest-program">{{ statistics.latest_program|default('-') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Abgedeckte Tage</span>
                            <span class="stat-value" id="days-covered">{{ statistics.days_covered|default('0') }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>Import-Statistiken</h3>
                </div>
                <div class="stat-card-body">
                    <div class="stat-item large">
                        <span class="stat-label">Importe gesamt</span>
                        <span class="stat-value" id="total-imports">{{ import_status.recent_imports|length|default('0') }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Erfolgreich</span>
                        <span class="stat-value success" id="successful-imports">{{ import_status.recent_imports|selectattr('status', 'equalto', 'success')|list|length|default('0') }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Fehlgeschlagen</span>
                        <span class="stat-value error" id="failed-imports">{{ import_status.recent_imports|selectattr('status', 'equalto', 'failed')|list|length|default('0') }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Letzter Import</span>
                        <span class="stat-value" id="last-import-time">{{ import_status.recent_imports[0].completed_at|default('-') }}</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>N√§chster Import</h3>
                </div>
                <div class="stat-card-body">
                    <div class="stat-item large">
                        <span class="stat-label">Geplant f√ºr</span>
                        <span class="stat-value" id="next-import">{{ import_status.next_scheduled_import|default('-') }}</span>
                    </div>
                    <div class="countdown" id="import-countdown">
                        <span class="countdown-value">-</span>
                        <span class="countdown-label">verbleibend</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Imports Table -->
        <div class="recent-imports">
            <div class="section-header">
                <h3>Letzte Importe</h3>
                <button class="btn-view-all" id="view-all-imports-btn">Alle anzeigen ‚Üí</button>
            </div>

            <div class="imports-table-container">
                <table class="imports-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Provider</th>
                            <th>Status</th>
                            <th>Programme</th>
                            <th>√úbersprungen</th>
                            <th>Dauer</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="imports-table-body">
                        {% for import in import_status.recent_imports %}
                        <tr class="import-row status-{{ import.status }}">
                            <td><span class="import-time">{{ import.started_at }}</span></td>
                            <td><span class="import-provider" data-provider-id="{{ import.provider_id }}">Provider #{{ import.provider_id }}</span></td>
                            <td><span class="status-badge status-{{ import.status }}">{{ import.status|upper }}</span></td>
                            <td><span class="import-count">{{ import.programs_imported|default('0') }}</span></td>
                            <td><span class="import-skipped">{{ import.programs_skipped|default('0') }}</span></td>
                            <td><span class="import-duration">{% if import.started_at and import.completed_at %}{{ import.started_at|time_diff(import.completed_at) }}{% else %}-{% endif %}</span></td>
                            <td><button class="btn-view-details" data-import-id="{{ import.id }}">Details</button></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="no-imports">Keine Importe gefunden</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="section-header">
                <h3>Statistik-Diagramme</h3>
                <div class="chart-controls">
                    <select id="chart-period" class="chart-select">
                        <option value="24h">Letzte 24 Stunden</option>
                        <option value="7d">Letzte 7 Tage</option>
                        <option value="30d">Letzte 30 Tage</option>
                        <option value="90d">Letzte 90 Tage</option>
                    </select>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>Programme pro Tag</h4>
                    <div class="chart-container">
                        <canvas id="programs-per-day-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Import-Erfolgsrate</h4>
                    <div class="chart-container">
                        <canvas id="import-success-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Kanal-Verteilung</h4>
                    <div class="chart-container">
                        <canvas id="channel-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="system-info">
            <div class="section-header">
                <h3>System-Informationen</h3>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h4>Ultimate UI</h4>
                    <div class="info-content">
                        <div class="info-item">
                            <span class="info-label">Version:</span>
                            <span class="info-value">1.0.0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Startzeit:</span>
                            <span class="info-value" id="ui-start-time">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Konfigurationsdatei:</span>
                            <span class="info-value">{{ config_path }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Theme:</span>
                            <span class="info-value">{{ config.ui.theme }}</span>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h4>Browser & Plattform</h4>
                    <div class="info-content">
                        <div class="info-item">
                            <span class="info-label">User-Agent:</span>
                            <span class="info-value" id="user-agent">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Plattform:</span>
                            <span class="info-value" id="platform">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Bildschirm:</span>
                            <span class="info-value" id="screen-resolution">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Online:</span>
                            <span class="info-value" id="online-status">-</span>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h4>Speichernutzung</h4>
                    <div class="info-content">
                        <div class="info-item">
                            <span class="info-label">Local Storage:</span>
                            <span class="info-value" id="local-storage-usage">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Session Storage:</span>
                            <span class="info-value" id="session-storage-usage">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Cache API:</span>
                            <span class="info-value" id="cache-api-status">Nicht unterst√ºtzt</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Import Details Modal -->
<div class="modal" id="import-details-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Import-Details</h3>
            <button class="modal-close" aria-label="Modal schlie√üen">√ó</button>
        </div>
        <div class="modal-body" id="import-details-content">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/monitoring.js') }}" defer></script>

<div id="monitoring-data"
     data-config="{{ config|tojson|safe }}"
     data-webepg-health="{{ webepg_health|tojson|safe }}"
     data-statistics="{{ statistics|tojson|safe }}"
     data-import-status="{{ import_status|tojson|safe }}"
     data-config-path="{{ config_path }}"
     data-error="{{ error|tojson|safe if error else 'null' }}">
</div>
{% endblock %}
